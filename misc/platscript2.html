<!DOCTYPE html>
<html>
  <head>
    <title>Platformer Script? #2</title>
    <meta charset="UTF-8">
    <meta name="description" content="Redoing because why not."/>
    <style>
      body {
        background-color: #4B4A5A;
      }
      canvas {
        border-radius: 2px;
        /* from r/place */
        -ms-interpolation-mode: bicubic;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        /* layer on top of each other */
        position: absolute;
        top: 10px;
        left: 10px;
      }
      canvas#level {
        background-color: white;
      }
    </style>
  </head>
  <body>
    <canvas id="level" height="360" width="480"></canvas>
    <canvas id="player" height="360" width="480"></canvas>

    <script src="../../sheep.js"></script>
    <script src="testlevel.js" charset="utf-8"></script>
    <script>
// rendering
var level=document.querySelector('#level'),
levelc=level.getContext('2d'),
player=document.querySelector('#player'),
playerc=player.getContext('2d'),
levelimg=new Image();
levelimg.onload=e=>{
  levelc.drawImage(levelimg,0,0);
};
levelimg.src=levelimagedata;
var keypresses={};
document.onkeydown=e=>{
  if (e.keyCode===65||e.keyCode===37) keypresses.left=true;
  if (e.keyCode===87||e.keyCode===38) keypresses.up=true;
  if (e.keyCode===68||e.keyCode===39) keypresses.right=true;
  if (e.keyCode===83||e.keyCode===40) keypresses.down=true;
};
document.onkeyup=e=>{
  if (e.keyCode===65||e.keyCode===37) keypresses.left=false;
  if (e.keyCode===87||e.keyCode===38) keypresses.up=false;
  if (e.keyCode===68||e.keyCode===39) keypresses.right=false;
  if (e.keyCode===83||e.keyCode===40) keypresses.down=false;
};
var x=60,y=50,xv=0,yv=0;
var HEIGHT=10,WIDTH=10,PIXEL_LENIENCY=1;
function pixelat(x,y) {
  var t=levelc.getImageData(x,y,1,1).data;
  return {r:t[0],g:t[1],b:t[2],a:t[3]/255};
}
function getSide(tempx,tempy,side) {
  var sides=[];
  switch (side) {
    case 'top':
      for (var i=0;i<WIDTH;i++) sides.push(pixelat(tempx+i,tempy-1).r);
      break;
    case 'bottom':
      for (var i=0;i<WIDTH;i++) sides.push(pixelat(tempx+i,tempy+HEIGHT).r);
      break;
    case 'left':
      for (var i=0;i<HEIGHT;i++) sides.push(pixelat(tempx-1,tempy+i).r);
      break;
    case 'right':
      for (var i=0;i<HEIGHT;i++) sides.push(pixelat(tempx+WIDTH,tempy+i).r);
      break;
  }
  return sides;
}
function pixelLeniencyArrayCheck(array,fromend) {
  fromend=fromend||false;
  for (var i=0;i<PIXEL_LENIENCY;i++) {
    if (fromend&&array[array.length-1-i]!==0) return false;
    else if (!fromend&&array[i]!==0) return false;
  }
  for (var i=PIXEL_LENIENCY;i<array.length;i++) {
    if (fromend&&array[array.length-1-i]===0) return false;
    else if (!fromend&&array[i]===0) return false;
  }
  return true;
}
playerc.fillStyle='rgba(233,30,99,0.8)';
function render() {
  if (keypresses.left) xv-=1;
  else if (keypresses.right) xv+=1;
  else xv*=0.8;
  if (keypresses.up) yv-=1;
  else if (keypresses.down) yv+=1;
  else yv*=0.8;
  /*
  var sides={
    bottom:getSide(x,y,'bottom')
  };
  yv+=1;
  if (~sides.bottom.indexOf(0)) {
    if (keypresses.left) xv-=1;
    if (keypresses.right) xv+=1;
    xv*=0.8;
    if (keypresses.up) yv-=14;
  }
  */
  // FOR FUTURE SEANS: Google "Digital differential analyzer (graphics algorithm)" whatever that is
  var xside=xv===0?'neither':xv>0?'right':'left',
  xabsvel=Math.abs(xv),
  xpositivity=xv===0?1:xv/xabsvel,
  xignore=false, // collided on x axis
  yside=yv===0?'neither':yv>0?'bottom':'top',
  yabsvel=Math.abs(yv),
  ypositivity=yv===0?1:yv/yabsvel,
  yignore=false,
  xyintchecks=[]; // possible x-y combos that land on a int for
  for (var i=0;i<xabsvel+0.5;i++) xyintchecks.push([i,xabsvel===0?0:i/xabsvel*yabsvel]);
  for (var i=0;i<yabsvel+0.5;i++) {
    if ((i=>{
      for (var j=0;j<xyintchecks.length;j++) if (xyintchecks[j][1]===i) return false;
      return true;
    })(i)) xyintchecks.push([yabsvel===0?0:i/yabsvel*xabsvel,i]);
  }
  if (xabsvel<0.5) xignore=true;
  if (yabsvel<0.5) yignore=true;
  xyintchecks.sort((a,b)=>a[0]===b[0]?a[1]-b[1]:a[0]-b[0]);
  for (var i=0;i<xyintchecks.length;i++) {
    var side;
    if (!xignore&&xyintchecks[i][0]>>0===xyintchecks[i][0]) {
      side=getSide(x+xyintchecks[i][0]*xpositivity,y+(yignore?yv:xyintchecks[i][1]*ypositivity),xside);
      if (~side.indexOf(0)) {
        if (pixelLeniencyArrayCheck(side,true)) y--;
        else if (pixelLeniencyArrayCheck(side,false)) y++;
        else {
          xv=xyintchecks[i][0]*xpositivity;
          xignore=true;
        }
      } else if (xabsvel!==0) {
        if (pixelLeniencyArrayCheck(getSide(x+xyintchecks[i][0]*xpositivity-xpositivity,y+(yignore?yv:xyintchecks[i][1]*ypositivity),'bottom'),xpositivity===-1)) y++;
        else if (pixelLeniencyArrayCheck(getSide(x+xyintchecks[i][0]*xpositivity-xpositivity,y+(yignore?yv:xyintchecks[i][1]*ypositivity),'top'),xpositivity===-1)) y--;
      }
      if (!xignore) xyintchecks[i][2]+=' (x) pass - '+side.join(',');
      else xyintchecks[i][2]+=' (x) FAIL - '+side.join(',');
    } else if (xignore) xyintchecks[i][2]+=' (x) skip';
    if (!yignore&&xyintchecks[i][1]>>0===xyintchecks[i][1]) {
      side=getSide(x+(xignore?xv:xyintchecks[i][0]*xpositivity),y+xyintchecks[i][1]*ypositivity,yside);
      if (~side.indexOf(0)) {
        yv=xyintchecks[i][1]*ypositivity;
        yignore=true;
      }
      if (!yignore) xyintchecks[i][2]+=' (y) pass - '+side.join(',');
      else xyintchecks[i][2]+=' (y) FAIL - '+side.join(',');
    } else if (yignore) xyintchecks[i][2]+=' (y) skip';
    if (xignore&&yignore) break;
  }
  playerc.clearRect(x-5,y-5,WIDTH+10,HEIGHT+10); // clear previous player location
  x+=xv; // change position
  y+=yv;
  playerc.fillRect(x>>0,y>>0,WIDTH,HEIGHT); // render player
  if (pixelat(x+WIDTH-1,y+HEIGHT-1).r===0) {
    // console.log(xyintchecks,xv,yv);
  }
  window.requestAnimationFrame(render);
}
window.requestAnimationFrame(render);
    </script>
  </body>
  <!-- MADE BY SEAN -->
</html>
