<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Scratch 3.0 HTMLifier</title>
    <meta charset="UTF-8">
    <meta name="description" content="Converts a Scratch 3.0 to HTML/JavaScript"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="../../sheep3.css">
    <script src="../../sheep3.js" charset="utf-8"></script>
    <script src="./hacky-file-getter.js" charset="utf-8"></script>
  </head>
  <body>
    <!-- Everything, probably -->
    <script src="https://sheeptester.github.io/scratch-vm/vm.min.js"></script>

    <script src="./UglifyJS2/minify.js"></script>
    <script src="./UglifyJS2/utils.js"></script>
    <script src="./UglifyJS2/ast.js"></script>
    <script src="./UglifyJS2/parse.js"></script>
    <script src="./UglifyJS2/transform.js"></script>
    <script src="./UglifyJS2/scope.js"></script>
    <script src="./UglifyJS2/output.js"></script>
    <script src="./UglifyJS2/compress.js"></script>
    <script src="./UglifyJS2/propmangle.js"></script>

    <script src="./hacky-file-getter.js" charset="utf-8"></script>
    <script src="./download.js" charset="utf-8"></script>

    <!-- This HTML file is truly ugly. -->

    <h1>Scratch 3.0 Project HTMLifier</h1>
    <h3><em>Convert Scratch to HTML</em></h3>
    <p>This packages your Scratch project into a single HTML file that can run on its own. The HTML file will be pretty big because it contains the entire Scratch engine as well as the assets used in the projects.</p>
    <p>The ask box will just be a simple JavaScript prompt, and the variable and list watchers look different. The project will automatically start, and there are no green flag or stop sign buttons to click on. The username block will report whatever you set as the "Username value."</p>
    <p><label><input type="radio" name="upload-mode" value="id" checked> Project ID: <input type="number" placeholder="Project ID" value="284516654" id="id" title="ID of the project hosted on the Scratch website to convert"></label></p>
    <p><label><input type="radio" name="upload-mode" value="file"> Upload project: <input type="file" id="file" accept=".sb,.sb2,.sb3"></label></p>
    <p><label for="title">Project title: </label><input type="text" placeholder="Project title" value="Zombie Cube Escape!" id="title" title="Text to display in the page tab"></p>
    <p><label for="username">Username value: </label><input type="text" placeholder="Username" value="griffpatch" id="username" title="Value that the username block reports"></p>
    <p>
      <label><input type="checkbox" id="compatibility" checked> Compatibility mode?<sup>1</sup></label>
      <label><input type="checkbox" id="turbo"> Turbo mode?</label>
    </p>
    <p>
      <button id="load">HTMLify with minification (slow)</button>
      <button id="load-no-minify">HTMLify without minification (recommended)</button>
      <button id="load-no-vm">HTMLify without VM<sup>2</sup></button>
    </p>
    <textarea id="error" rows="8" cols="40" placeholder="Log" readonly></textarea>
    <p>Made by <a href="https://scratch.mit.edu/users/Sheep_maker/">Sheep_maker</a>; libraries used: <a href="https://github.com/mishoo/UglifyJS2/tree/harmony">uglify-es</a>, <a href="https://github.com/LLK/scratch-vm/">scratch-vm</a>, <a href="http://danml.com/download.html">download.js</a></p>
    <p><sup>1</sup>Compatibility mode forces projects to run at 30 FPS, like in Scratch 2.0. Turning this off allows the project to run at a higher framerate (usually 60 FPS, depending on the computer screen's refresh rate).</p>
    <p><sup>2</sup>The Scratch engine won't be included in the HTML file, so it'll be smaller, but it'll require internet connection.</p>
    <script type="text/javascript">
const scratchURLs = [
  'https://sheeptester.github.io/scratch-vm/vm.min.js',
  './benchmark.js'
];
function getDataURL(url) {
  return fetch(url).then(r => r.blob()).then(blob => new Promise(res => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.readAsDataURL(blob);
  }));
}
function minifyScripts(scripts) { // so the "Minifying..." log shows
  return new Promise(res => {
    setTimeout(() => {
      res(minify(scripts, {}));
    }, 100);
  });
}
function downloadAsHTML(projectSrc, {title = 'Project', username = 'griffpatch', mode, log = console.log}) {
  const noVM = mode === 'no-vm';
  const minify = mode !== 'no-minify';
  return Promise.all([
    // make preface variables
    projectSrc.id
      ? log('Getting asset URLs...') && runBenchmark(projectSrc.id).then(({assets, projectJSON}) => {
        log('Getting assets...');
        return Promise.all([
          getDataURL(projectJSON).then(data => projectJSON = data),
          ...Object.keys(assets).map(assetId => getDataURL(assets[assetId]).then(data => assets[assetId] = data))
        ]).then(() => {
          return `var SRC = "id", PROJECT_JSON = "${projectJSON}",`
            + `ASSETS = ${JSON.stringify(assets)},`
            + `DESIRED_USERNAME = ${JSON.stringify(username)},`
            + `COMPAT = ${compatibility.checked}, TURBO = ${turbo.checked};`;
        });
      })
      : Promise.resolve(`var SRC = "file", FILE = "${projectSrc.data}";`
        + `DESIRED_USERNAME = ${JSON.stringify(username)},`
        + `COMPAT = ${compatibility.checked}, TURBO = ${turbo.checked};`),

    // fetch scripts
    Promise.all((noVM ? ['./benchmark.js'] : scratchURLs)
      .map(url => fetch(url)
      .then(r => r.text())))
      .then(scripts => {
        log('Scratch scripts obtained...');
        // remove dumb </ script>s in comments
        return scripts.join('\n').replace('</scr' + 'ipt>', '');
      }),

    // fetch template
    fetch(noVM ? './template-quick.html' : './template.html')
      .then(r => r.text())
  ]).then(async ([preface, scripts, template]) => {
    scripts = preface + scripts;
    if (minify) {
      log('Minifying...');
      scripts = await minifyScripts(scripts);
      if (scripts.error) throw scripts.error;
      else scripts = scripts.code;
    }
    log('Done!');
    return template
      .replace('{TITLE}', () => title)
      .replace('{SCRIPTS}', () => scripts);
  });
}
const loadBtn = document.getElementById('load');
const loadNoMinifyBtn = document.getElementById('load-no-minify');
const loadNoVMBtn = document.getElementById('load-no-vm');
const title = document.getElementById('title');
const id = document.getElementById('id');
const username = document.getElementById('username');
const file = document.getElementById('file');
const error = document.getElementById('error');
const compatibility = document.getElementById('compatibility');
const turbo = document.getElementById('turbo');
const buttons = [loadBtn, loadNoMinifyBtn, loadNoVMBtn];
function getProject() {
  if (document.querySelector('input[name="upload-mode"]:checked').value === 'file') {
    if (!file.files || !file.files[0]) return Promise.reject(new Error('No file selected'));
    return new Promise(res => {
      const reader = new FileReader();
      reader.onload = () => res({data: reader.result});
      reader.readAsDataURL(file.files[0]);
    });
  } else {
    return Promise.resolve({id: id.value});
  }
}
function load(mode) {
  buttons.forEach(btn => btn.disabled = true);
  error.value = '';
  getProject()
    .then(src => downloadAsHTML(src, {
      title: title.value,
      username: username.value,
      log: output => error.value += output + '\n',
      mode: mode
    }))
    .then(html => {
      download(html, 'project.html', 'text/html');
      buttons.forEach(btn => btn.disabled = false);
    }).catch(err => {
      console.log(err);
      error.value = err.message;
      buttons.forEach(btn => btn.disabled = false);
    });
}
loadBtn.addEventListener('click', e => load('normal'));
loadNoMinifyBtn.addEventListener('click', e => load('no-minify'));
loadNoVMBtn.addEventListener('click', e => load('no-vm'));
    </script>
  </body>
</html>
